
# Upload Clienteling List

## Structure

- **`src`**: Source code as per the below:
- **`src/shared`**: Utilities or other shared/common code
- **`src/[FUNCTION NAME]`**: Each folder contains a function
- **`tests/units`**: unit tests
- **`config`**: environment variables and secrets

## Development

1. `yarn` to install packages
2. state the `ELISE_SERVER_URL` in  `/config/.env.development`
4. `sls offline --stage development` to run the app

## Endpoints

1. `POST /api/upload-clienteling-list`
2. `POST /api/elsie` (mock Elsie endpoint that should only be called by the endpoint abve)

To trigger the API, you can enter the following command with the path of your xlsx file

```bash
curl --location --request POST 'http://localhost:7071/api/upload-clienteling-list' \
--header 'Content-Type: multipart/form-data' \
--form 'file=@"your/path/to/the/xxx.xlsx"'
```

A 200 response will look like:

```bash

{
    "message": "You have successully parsed the xlsx file, transformed it to csv and sent it to the Elsie server.",
}

```

And you should also see the clienteling_data_{created_timestamp}.csv in your root directory.

## Test

1. `yarn test` to run unit tests


## Staging Deployment

1. `az account clear`
2. `az login` to login with the credentials and then you should see a json in the terminal that contains the subscription id
3. `az account set -s <subscription-id>` 
4. `az ad sp create-for-rbac --name <my-unique-name>` to generate service principal for Azure Subscription
5. The terminal should yield something like:
```bash
{
  "appId": "<servicePrincipalId>",
  "displayName": "<name>",
  "name": "<name>",
  "password": "<password>",
  "tenant": "<tenantId>"
}
```
6. Set environment variables with values from above service principal
```bash
export AZURE_SUBSCRIPTION_ID='<subscriptionId (see above, step 2)>'
export AZURE_TENANT_ID='<tenantId>'
export AZURE_CLIENT_ID='<servicePrincipalId>'
export AZURE_CLIENT_SECRET='<password>'
```

7. run `sls deploy --stage <environment flag>` to deploy the app to the specified environment (eg. staging / production)
8. To try out the Elsie mock server on Azure, need to change it to the URL of the staging elsie function generated by Azure, and redeploy it again
